// Generated by CoffeeScript 1.6.3
var Mailgun;

Mailgun = require('mailgun').Mailgun;

module.exports = function(grunt) {
  return grunt.registerMultiTask('mailgun', 'Send emails through mailgun', function() {
    var body, done, key, mail, recipient, sender, subject, _ref;
    done = this.async();
    _ref = this.data.options, sender = _ref.sender, recipient = _ref.recipient, subject = _ref.subject, body = _ref.body, key = _ref.key;
    mail = new Mailgun(key);
    if (this.files.length > 0) {
      return this.filesSrc.forEach(function(filePath) {
        var raw;
        body = grunt.file.read(filePath);
        raw = "From: " + sender + "\nTo: " + recipient + "\nContent-Type: text/html; charset=utf-8\nSubject: " + subject + "\n\n " + body;
        return mail.sendRaw(sender, recipient, raw, function(err) {
          if (err) {
            grunt.log.error('Error: ' + err);
          } else {
            grunt.log.writeln('Sent email to ' + recipient);
          }
          return done();
        });
      });
    } else {
      return mail.sendText(sender, recipient, subject, body, function(err) {
        if (err) {
          grunt.log.error('Error: ' + err);
        } else {
          grunt.log.writeln('Sent email to ' + recipient);
        }
        return done();
      });
    }
  });
};
